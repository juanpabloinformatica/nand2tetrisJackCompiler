#include "CompilationEngine.hpp"
#include <cassert>

inline std::string CompilationEngine::tokenListKey(int offset) {
  return this->tokenList.at(this->tokenListIndex + offset)->begin()->first;
}
inline JackTypes::TokenType CompilationEngine::tokenListValue(int offset) {
  return this->tokenList.at(this->tokenListIndex + offset)->begin()->second;
}
/*With this I will be able to re-use the token-list generated by the tokenizer*/
/*I don't really get the whole process I think that the advance and stuff is to
 * move get token*/
/*and then let the compilation takes cares, nevertheless I will continue this
 * way then I will see*/
CompilationEngine::CompilationEngine(
    const std::vector<std::map<std::string, JackTypes::TokenType> *> &tokenList)
#ifdef DEBUG
    /*:outputFile(std::string("./test/output_test_1.xml")),*/  /*test_1*/
    /*: outputFile(std::string("./test/output_test_2.xml")),*/ /*test_2*/
    /*: outputFile(std::string("./test/output_test_3.xml")),*/ /*test_3*/
    /*: outputFile(std::string("./test/output_test_4.xml")),*/ /*test_4*/
    : outputFile(std::string("./test/output_test_5.xml")),     /*test_5*/
#else
    : outputFile(std::string("./test/output_compilation.xml")),
#endif

      tokenList(tokenList),
#ifdef DEBUG
      /*tokenListIndex(tokenList.size() - 6)*/ /*For test_1*/
      /*tokenListIndex(tokenList.size() - 6)*/ /*For test_2*/
      /*tokenListIndex(tokenList.size() - 1)*/ /*For test_3*/
      /*tokenListIndex(tokenList.size() - 1)*/ /*For test_4*/
      tokenListIndex(tokenList.size() - 4)     /*For test_5*/

#else
      tokenListIndex(0),
#endif
      flagIsDoStatement(false) {
}

void CompilationEngine::run() {
#ifndef DEBUG
  this->compileClass();
#else
  this->compileExpression();
#endif
}

void CompilationEngine::writeToFileStartNonTerminal(
    const std::string &nonTerminal) {
  this->outputFile << "\t" << nonTerminal << "\n";
  return;
}
void CompilationEngine::writeToFileFinishNonTerminal(
    const std::string &nonTerminal) {
  this->outputFile << nonTerminal << "\n";
  return;
}
void CompilationEngine::writeToFile() {
  JackTypes::TokenType tokenType = this->tokenListValue();
  const std::string &token = this->tokenListKey();

  /*identation*/
  this->outputFile << "\t";

  switch (tokenType) {
  case JackTypes::KEYWORD:
    this->outputFile << "<keyword> " << token << " </keyword>" << "\n";
    break;
  case JackTypes::SYMBOL: {
    std::string symbol = token;
    if (token == "<")
      symbol = "&lt;";
    if (token == ">")
      symbol = "&gt;";
    if (token == "\"")
      symbol = "quot;";
    if (token == "&")
      symbol = "&amp;";

    this->outputFile << "<symbol> " << symbol << " </symbol>" << "\n";
  } break;
  case JackTypes::IDENTIFIER:
    this->outputFile << "<identifier> " << token << " </identifier>"
                     << "\n";
    break;
  case JackTypes::INT_CONST:
    this->outputFile << "<integerConstant> " << token << " </integerConstant>"
                     << "\n";
    break;
  case JackTypes::STRING_CONST:
    this->outputFile << "<stringConstant> " << token << " </stringConstant>"
                     << "\n";
    break;
  default:
    break;
  }
}

/*Do a kind of wrapper of the following*/
void CompilationEngine::compileClass() {
  /*to improve this*/
  this->writeToFileStartNonTerminal("<class>");

  if (!(this->tokenListKey() == "class"))
    return;
  this->writeToFile();
  this->tokenListIndex++;
  if (!(this->tokenListValue() == JackTypes::IDENTIFIER))
    return;
  this->writeToFile();
  this->tokenListIndex++;
  if (!(this->tokenListKey() == "{"))
    return;
  this->writeToFile();
  this->tokenListIndex++;

  while (this->compileClassVarDec())
    ;

  while (this->compileSubroutine())
    ;

  if (!(this->tokenListKey() == "}"))
    return;
  this->writeToFile();
  this->tokenListIndex++;

  this->writeToFileFinishNonTerminal("</class>");
  return;
}
bool CompilationEngine::compileClassVarDec() {

  // int tmpBeforeIndex = this->tokenListIndex;
  // int tmpAfterIndex;

  if (!(this->tokenListKey() == "static" || this->tokenListKey() == "field"))
    return false;

  this->writeToFileStartNonTerminal("<classVarDec>");

  this->writeToFile();
  this->tokenListIndex++;

  if (!(this->tokenListKey() == "int" || this->tokenListKey() == "char" ||
        this->tokenListKey() == "boolean" ||
        this->tokenListValue() == JackTypes::IDENTIFIER))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  if (!(this->tokenListValue() == JackTypes::IDENTIFIER))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  while ((this->tokenListKey() == ",") &&
         /*offset */
         (this->tokenListValue(1) == JackTypes::IDENTIFIER)) {

    this->writeToFile();
    this->tokenListIndex++;
    this->writeToFile();
    this->tokenListIndex++;
  }
  if (!(this->tokenListKey() == ";"))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  // this->writeToFileStartNonTerminal("<classVarDec>");
  //
  // tmpAfterIndex = this->tokenListIndex;
  // this->tokenListIndex = tmpBeforeIndex;
  // /*Check that is not writting one more*/
  // for (; this->tokenListIndex < tmpAfterIndex; this->tokenListIndex++)
  // this->writeToFile();

  this->writeToFileFinishNonTerminal("</classVarDec>");

  return true;
}
bool CompilationEngine::compileSubroutine() {
  // int tmpBeforeIndex = this->tokenListIndex;
  // int tmpAfterIndex;

  if (!(this->tokenListKey() == "constructor" ||
        this->tokenListKey() == "function" || this->tokenListKey() == "method"))
    return false;

  this->writeToFileStartNonTerminal("<subroutineDec>");

  this->writeToFile();
  this->tokenListIndex++;

  if (!(this->tokenListKey() == "void" || this->tokenListKey() == "int" ||
        this->tokenListKey() == "char" || this->tokenListKey() == "boolean" ||
        this->tokenListValue() == JackTypes::IDENTIFIER))

    return false;

  this->writeToFile();
  this->tokenListIndex++;

  /*subroutine name*/
  if (!(this->tokenListValue() == JackTypes::IDENTIFIER))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  if (!(this->tokenListKey() == "("))
    return false;
  this->writeToFile();
  this->tokenListIndex++;

  this->compileParameterList();

  if (!(this->tokenListKey() == ")"))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  /*This needs to be in another function*/
  /*subroutine body*/
  if (!this->compileSubroutineBody())
    return false;
  // this->writeToFileStartNonTerminal("<subroutineBody>");
  // if (!(this->tokenListKey() == "{"))
  //   return false;
  // this->writeToFile();
  // this->tokenListIndex++;
  //
  // while (this->compileVarDec())
  //   ;
  //
  // this->compileStatements();
  //
  // if (!(this->tokenListKey() == "}"))
  //   return false;
  // this->writeToFile();
  // this->tokenListIndex++;

  // this->writeToFileFinishNonTerminal("</subroutineBody>");

  // this->writeToFileStartNonTerminal("<subroutineDec>");
  //
  // tmpAfterIndex = this->tokenListIndex;
  // this->tokenListIndex = tmpBeforeIndex;
  // /*Check that is not writting one more*/
  // for (; this->tokenListIndex < tmpAfterIndex; this->tokenListIndex++)
  // this->writeToFile();
  this->writeToFileFinishNonTerminal("</subroutineDec>");

  return true;
}
bool CompilationEngine::compileSubroutineBody() {

  if (!(this->tokenListKey() == "{"))
    return false;

  this->writeToFileStartNonTerminal("<subroutineBody>");
  this->writeToFile();
  this->tokenListIndex++;

  while (this->compileVarDec())
    ;

  this->compileStatements();

  if (!(this->tokenListKey() == "}"))
    return false;
  this->writeToFile();
  this->tokenListIndex++;
  this->writeToFileFinishNonTerminal("</subroutineBody>");

  return true;
}
bool CompilationEngine::compileStatements() {
  this->writeToFileFinishNonTerminal("<statements>");
  while (this->compileLet() || this->compileIf() || this->compileWhile() ||
         this->compileDo() || this->compileReturn())
    ;
  this->writeToFileFinishNonTerminal("</statements>");
  return true;
}
bool CompilationEngine::compileLet() {
  // int tmpBeforeIndex = this->tokenListIndex;
  // int tmpAfterIndex;

  if (!(this->tokenListKey() == "let"))
    return false;

  this->writeToFileFinishNonTerminal("<letStatement>");
  this->writeToFile();
  this->tokenListIndex++;

  if (!(this->tokenListValue() == JackTypes::IDENTIFIER))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  if (this->tokenListKey() == "[") {

    this->writeToFile();
    this->tokenListIndex++;
    if (!this->compileExpression()) /*this->compileExpression();*/
      return false;
    if (!(this->tokenListKey() == "]"))
      return false;
    this->writeToFile();
    this->tokenListIndex++;
  }
  if (!(this->tokenListKey() == "="))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  if (!this->compileExpression()) /*this->compileExpression();*/
    return false;

  if (!(this->tokenListKey() == ";"))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  // this->writeToFileFinishNonTerminal("<letStatement>");

  // tmpAfterIndex = this->tokenListIndex;
  // this->tokenListIndex = tmpBeforeIndex;
  // /*Check that is not writting one more*/
  // for (; this->tokenListIndex < tmpAfterIndex; this->tokenListIndex++)
  //   writeToFile();
  this->writeToFileFinishNonTerminal("</letStatement>");

  return true;
}

bool CompilationEngine::compileIf() {
  // this->writeToFileFinishNonTerminal("<ifStatement>");
  // int tmpBeforeIndex = this->tokenListIndex;
  // int tmpAfterIndex;

  if (!(this->tokenListKey() == "if"))
    return false;

  this->writeToFileFinishNonTerminal("<ifStatement>");
  this->writeToFile();
  this->tokenListIndex++;

  if (!(this->tokenListKey() == "("))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  if (!this->compileExpression()) /*this->compileExpression();*/
    return false;

  if (!(this->tokenListKey() == ")"))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  if (!(this->tokenListKey() == "{"))
    return false;
  this->writeToFile();
  this->tokenListIndex++;

  if (!this->compileStatements()) /*this->compileStatements();*/
    return false;

  if (!(this->tokenListKey() == "}"))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  if (this->tokenListKey() == "else") {
    this->writeToFile();
    this->tokenListIndex++;
    if (!(this->tokenListKey() == "{"))
      return false;

    this->writeToFile();
    this->tokenListIndex++;
    if (!this->compileStatements())
      return false;
    if (!(this->tokenListKey() == "}"))
      return false;

    this->writeToFile();
    this->tokenListIndex++;
  }
  // this->writeToFileFinishNonTerminal("<ifStatement>");
  //
  // tmpAfterIndex = this->tokenListIndex;
  // this->tokenListIndex = tmpBeforeIndex;
  // /*Check that is not writting one more*/
  // for (; this->tokenListIndex < tmpAfterIndex; this->tokenListIndex++)
  //   this->writeToFile();
  //
  this->writeToFileFinishNonTerminal("</ifStatement>");

  // ////this->writeToFileFinishNonTerminal("</ifStatement>");
  return true;
}
bool CompilationEngine::compileWhile() {

  // int tmpBeforeIndex = this->tokenListIndex;
  // int tmpAfterIndex;

  if (!(this->tokenListKey() == "while"))
    return false;

  this->writeToFileFinishNonTerminal("<whileStatement>");
  this->writeToFile();
  this->tokenListIndex++;

  if (!(this->tokenListKey() == "("))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  if (!this->compileExpression()) /*this->compileExpression();*/
    return false;

  if (!(this->tokenListKey() == "{"))
    return false;
  this->writeToFile();
  this->tokenListIndex++;

  if (!this->compileStatements()) /*this->compileStatements();*/
    return false;

  if (!(this->tokenListKey() == "}"))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  // this->writeToFileFinishNonTerminal("<whileStatement>");
  //
  // tmpAfterIndex = this->tokenListIndex;
  // this->tokenListIndex = tmpBeforeIndex;
  // /*Check that is not writting one more*/
  // for (; this->tokenListIndex < tmpAfterIndex; this->tokenListIndex++)
  //   this->writeToFile();
  this->writeToFileFinishNonTerminal("</whileStatement>");
  return true;
}
bool CompilationEngine::compileDo() {
  // int tmpBeforeIndex = this->tokenListIndex;
  // int tmpAfterIndex;

  // this->writeToFileFinishNonTerminal("<doStatement>");

  if (!(this->tokenListKey() == "do"))
    return false;

  this->writeToFileFinishNonTerminal("<doStatement>");
  this->writeToFile();
  this->tokenListIndex++;

  this->flagIsDoStatement = true;
  if (!this->compileExpression())
    return false;
  this->flagIsDoStatement = false;

  if (!(this->tokenListKey() == ";"))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  // if (!(this->tokenListValue() == JackTypes::IDENTIFIER))
  //   return false;
  //
  // // this->writeToFile();
  // this->tokenListIndex++;
  //
  // if (!(this->tokenListKey() == "("))
  //   return false;
  //
  // // this->writeToFile();
  // this->tokenListIndex++;
  //
  // this->compileExpressionList();
  //
  // if (!(this->tokenListKey() == ")"))
  //   return false;
  //
  // // this->writeToFile();
  // this->tokenListIndex++;
  //
  //
  // /*This is not well done because the compiler doesn't know if is a class
  // name
  //  * or subroutine everything*/
  // /*is threated as identfier*/
  // if (!(this->tokenListValue() == JackTypes::IDENTIFIER))
  //   return false;
  //
  // // this->writeToFile();
  // this->tokenListIndex++;
  // //
  // if (!(this->tokenListKey() == "."))
  //   return false;
  //
  // // this->writeToFile();
  // this->tokenListIndex++;
  //
  // if (!(this->tokenListValue() == JackTypes::IDENTIFIER))
  //   return false;
  //
  // // this->writeToFile();
  // this->tokenListIndex++;
  //
  // if (!(this->tokenListKey() == "("))
  //   return false;
  //
  // // this->writeToFile();
  // this->tokenListIndex++;
  //
  // this->compileExpressionList();
  //
  // if (!(this->tokenListKey() == ")"))
  //   return false;
  //
  // // this->writeToFile();
  //
  // this->tokenListIndex++;

  // this->writeToFileFinishNonTerminal("<doStatement>");
  //
  // tmpAfterIndex = this->tokenListIndex;
  // this->tokenListIndex = tmpBeforeIndex;
  // /*Check that is not writting one more*/
  // for (; this->tokenListIndex < tmpAfterIndex; this->tokenListIndex++)
  //   this->writeToFile();
  this->writeToFileFinishNonTerminal("</doStatement>");
  return true;
}
bool CompilationEngine::compileReturn() {
  // int tmpBeforeIndex = this->tokenListIndex;
  // int tmpAfterIndex;

  if (!(this->tokenListKey() == "return"))
    return false;

  this->writeToFileFinishNonTerminal("<returnStatement>");
  this->writeToFile();
  this->tokenListIndex++;
  this->flagIsDoStatement = true;
  if (!this->compileExpression())
    return false;
  this->flagIsDoStatement = false;

  if (!(this->tokenListKey() == ";"))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  // this->writeToFileFinishNonTerminal("<returnStatement>");
  //
  // tmpAfterIndex = this->tokenListIndex;
  // this->tokenListIndex = tmpBeforeIndex;
  // /*Check that is not writting one more*/
  // for (; this->tokenListIndex < tmpAfterIndex; this->tokenListIndex++)
  //   this->writeToFile();
  this->writeToFileFinishNonTerminal("</returnStatement>");
  return true;
}

void CompilationEngine::compileParameterList() {
  // int tmpBeforeIndex = this->tokenListIndex;
  // int tmpAfterIndex;

  this->writeToFileFinishNonTerminal("<parameterList>");
  /*Check there are no parameters*/
  if (this->tokenListKey() == ")") {
    this->writeToFileFinishNonTerminal("</parameterList>");
    return;
  }

  if (!(this->tokenListKey() == "int" || this->tokenListKey() == "char" ||
        this->tokenListKey() == "boolean" ||
        this->tokenListValue() == JackTypes::IDENTIFIER))
    return;

  this->writeToFileFinishNonTerminal("<parameterList>");
  this->writeToFile();
  this->tokenListIndex++;
  if (!(this->tokenListValue() == JackTypes::IDENTIFIER))
    return;

  this->writeToFile();
  this->tokenListIndex++;
  while ((this->tokenListKey() == ",") &&
         /*offset */
         (this->tokenListValue(1) == JackTypes::IDENTIFIER)) {
    this->writeToFile();
    this->tokenListIndex++;
    this->writeToFile();
    this->tokenListIndex++;
  }
  // this->writeToFileStartNonTerminal("<parameterList>");
  // tmpAfterIndex = this->tokenListIndex;
  // this->tokenListIndex = tmpBeforeIndex;
  // /*Check that is not writting one more*/
  // for (; this->tokenListIndex < tmpAfterIndex; this->tokenListIndex++)
  //   this->writeToFile();
  this->writeToFileFinishNonTerminal("</parameterList>");

  return;
}
bool CompilationEngine::compileExpression() {
  // int tmpBeforeIndex = this->tokenListIndex;
  // int tmpAfterIndex;
  int iteration = 0;
  bool succesfull = true;

  if (!this->flagIsDoStatement)
    this->writeToFileStartNonTerminal("<expression>");

  /*for be working just now*/
  // this->tokenListIndex++;
  this->compileTerm(&iteration, &succesfull);
  if (!succesfull)
    return false;

  iteration = 0;
  succesfull = true;

  /*not like this because I need to update the index*/
  // while (this->isOp() && this->compileTerm())
  //   ;
  while (true) {

    if ((size_t)this->tokenListIndex > this->tokenList.size() - 1)
      break;

    if (!JackTypes::tokenIsOp(this->tokenListKey()))
      break;

    this->writeToFile();
    this->tokenListIndex++;
    this->compileTerm(&iteration, &succesfull);
    if (!succesfull)
      return false;
  }
  // /*Code to be written*/
  // this->writeToFileStartNonTerminal("<expression>");
  //
  // tmpAfterIndex = this->tokenListIndex;
  // this->tokenListIndex = tmpBeforeIndex;
  // /*Check that is not writting one more*/
  // for (; this->tokenListIndex < tmpAfterIndex; this->tokenListIndex++)
  //   this->writeToFile();
  if (!this->flagIsDoStatement)
    this->writeToFileFinishNonTerminal("</expression>");

  return true;
}
// wrapper of this one
// testing with  i*(-j)
// I will unit-test this function
void CompilationEngine::compileTerm(int *iteration, bool *succesfull) {

  /*this will be the same */
  /*never theless the tokenListIndex will be incremented because is global*/

  if ((size_t)this->tokenListIndex > this->tokenList.size() - 1) {
    return;
  }

  /*First check that term is correct*/
  if (JackTypes::INT_CONST == this->tokenListValue() ||
      JackTypes::STRING_CONST == this->tokenListValue() ||
      JackTypes::KEYWORD == this->tokenListValue()) {
    this->writeToFileStartNonTerminal("<term>");
    this->writeToFile();
    *iteration += 1;
    this->tokenListIndex++;
    this->compileTerm(iteration, succesfull);
    this->writeToFileFinishNonTerminal("</term>");
    return;
  }

  if (this->tokenListValue() == JackTypes::IDENTIFIER &&
      this->tokenListKey(1) == "[") {
    this->writeToFileStartNonTerminal("<term>");
    this->writeToFile();
    this->tokenListIndex++;
    if (this->tokenListKey() == "[") {
      this->writeToFile();
      this->tokenListIndex++;
      if (!this->compileExpression()) {
        *succesfull = false;
        return;
      }
      if (!(this->tokenListKey() == "]")) {
        *succesfull = false;
        return;
      }
      *iteration += 1;
      this->writeToFile();
      this->tokenListIndex++;
      this->compileTerm(iteration, succesfull);
      this->writeToFileFinishNonTerminal("</term>");
      return;
    }
  }
  if ((this->tokenListValue() == JackTypes::IDENTIFIER &&
       this->tokenListKey(1) == "(")) {
    this->writeToFileStartNonTerminal("<term>");
    if (!this->_compileSubroutineCall()) {
      *succesfull = false;
      return;
    }
    *iteration += 1;
    this->compileTerm(iteration, succesfull);
    this->writeToFileFinishNonTerminal("</term>");
    return;
  }
  if ((this->tokenListValue() == JackTypes::IDENTIFIER &&
       this->tokenListKey(1) == ".")) {
    if (!this->flagIsDoStatement)
      this->writeToFileStartNonTerminal("<term>");
    this->writeToFile();
    this->tokenListIndex++;
    this->writeToFile();
    this->tokenListIndex++;
    if (!this->_compileSubroutineCall()) {
      *succesfull = false;
      return;
    }
    *iteration += 1;
    this->compileTerm(iteration, succesfull);
    if (!this->flagIsDoStatement)
      this->writeToFileFinishNonTerminal("</term>");
    return;
  }
  if (this->tokenListValue() == JackTypes::IDENTIFIER) {
    this->writeToFileStartNonTerminal("<term>");
    this->writeToFile();
    *iteration += 1;
    this->tokenListIndex++;
    this->compileTerm(iteration, succesfull);
    this->writeToFileFinishNonTerminal("</term>");
    return;
  }
  if (this->tokenListKey() == "(") {
    this->writeToFileStartNonTerminal("<term>");
    this->writeToFile();
    this->tokenListIndex++;
    if (!this->compileExpression()) {
      *succesfull = false;
      return;
    }
    if (!(this->tokenListKey() == ")")) {

      *succesfull = false;
      return;
    }
    *iteration += 1;
    this->writeToFile();
    this->tokenListIndex++;
    this->compileTerm(iteration, succesfull);
    this->writeToFileFinishNonTerminal("</term>");
    return;
  }
  if (JackTypes::tokenIsUnaryOp(this->tokenListKey())) {
    this->writeToFileStartNonTerminal("<term>");
    this->writeToFile();
    *iteration += 1;
    this->tokenListIndex++;
    this->compileTerm(iteration, succesfull);
    this->writeToFileFinishNonTerminal("</term>");
    return;
  }

  if (JackTypes::tokenIsKeywordConstant(this->tokenListKey())) {
    this->writeToFileStartNonTerminal("<term>");
    this->writeToFile();
    *iteration += 1;
    this->tokenListIndex++;
    this->compileTerm(iteration, succesfull);
    this->writeToFileFinishNonTerminal("</term>");
    return;
  }
  return;
}

/*Personal idea*/
bool CompilationEngine::_compileSubroutineCall() {

  if (!(this->tokenListValue() == JackTypes::IDENTIFIER))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  if (!(this->tokenListKey() == "("))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  this->compileExpressionList();

  if (!(this->tokenListKey() == ")"))
    return false;

  this->writeToFile();
  this->tokenListIndex++;
  return true;
}

bool CompilationEngine::compileVarDec() {
  // int tmpBeforeIndex = this->tokenListIndex;
  // int tmpAfterIndex;

  if (!(this->tokenListKey() == "var"))
    return false;

  this->writeToFileFinishNonTerminal("<varDec>");
  this->writeToFile();
  this->tokenListIndex++;

  if (!(this->tokenListKey() == "int" || this->tokenListKey() == "char" ||
        this->tokenListKey() == "boolean" ||
        this->tokenListValue() == JackTypes::IDENTIFIER))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  if (!(this->tokenListValue() == JackTypes::IDENTIFIER))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  while ((this->tokenListKey() == ",") &&
         /*offset */
         (this->tokenListValue(1) == JackTypes::IDENTIFIER)) {
    this->writeToFile();
    this->tokenListIndex++;
    this->writeToFile();
    this->tokenListIndex++;
  }

  if (!(this->tokenListKey() == ";"))
    return false;

  this->writeToFile();
  this->tokenListIndex++;

  // this->writeToFileStartNonTerminal("<varDec>");

  // tmpAfterIndex = this->tokenListIndex;
  // this->tokenListIndex = tmpBeforeIndex;
  // /*Check that is not writting one more*/
  // for (; this->tokenListIndex < tmpAfterIndex; this->tokenListIndex++)
  //   this->writeToFile();
  this->writeToFileFinishNonTerminal("</varDec>");

  return true;
}
void CompilationEngine::compileExpressionList() {
  // int tmpBeforeIndex = this->tokenListIndex;
  // int tmpAfterIndex;
  this->writeToFileStartNonTerminal("<expressionList>");
  if (this->tokenListKey() == ")") {
    this->writeToFileFinishNonTerminal("</expressionList>");
    return;
  }

  /*code*/
  if (!this->compileExpression())
    return;
  //

  while (true) {
    if (!(this->tokenListKey() == ","))
      break;
    this->tokenListIndex++;
    if (!this->compileExpression())
      break;
  }

  // this->writeToFileStartNonTerminal("<expressionList>");
  //
  // tmpAfterIndex = this->tokenListIndex;
  // this->tokenListIndex = tmpBeforeIndex;
  // /*Check that is not writting one more*/
  // for (; this->tokenListIndex < tmpAfterIndex; this->tokenListIndex++)
  //   this->writeToFile();
  this->writeToFileFinishNonTerminal("</expressionList>");

  return;
}

const std::vector<std::map<std::string, JackTypes::TokenType> *> &
CompilationEngine::getTokenList() {
  return this->tokenList;
}
CompilationEngine::~CompilationEngine() {
  std::cout << "Calling compilation engine destructor" << "\n";
}
